apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: observability
data:
  alertmanager.yml: |
    global:
      slack_api_url_file: /etc/alertmanager/secrets/slack_api_url
      resolve_timeout: 5m

    route:
      receiver: 'slack-alerts'
      group_by: ['alertname', 'job']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 3h
      routes:
        - match:
            severity: critical
          receiver: 'slack-critical'
          continue: true
        - match:
            severity: warning
          receiver: 'slack-warning'
          continue: true
        - match:
            team: backend
          receiver: 'slack-backend'
    
    inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'region']
    
    receivers:
      - name: 'slack-alerts'
        slack_configs:
          - channel: '#alerts'
            send_resolved: true
            icon_emoji: '{{ if eq .Status "firing" }}:fire:{{ else }}:ok:{{ end }}'
            color: '{{ template "slack.color" . }}'
            title: '{{ template "slack.title" . }}'
            text: '{{ template "slack.text" . }}'
            footer: 'PortfoGram Alertmanager | <{{ template "slack.runbook" . }}|View Runbook>'
            actions:
              - type: button
                text: 'Open in Grafana'
                url: '{{ template "slack.grafana" . }}'

      
      - name: 'slack-critical'
        slack_configs:
          - channel: '#critical-alerts'
            send_resolved: true
            icon_emoji: '{{ if eq .Status "firing" }}:fire:{{ else }}:ok:{{ end }}'
            color: '{{ template "slack.color" . }}'
            title: '{{ template "slack.title" . }}'
            text: '{{ template "slack.text" . }}'
            footer: 'Alertmanager'

      - name: 'slack-warning'
        slack_configs:
          - channel: '#warning-alerts'
            send_resolved: true
            icon_emoji: '{{ if eq .Status "firing" }}:warning:{{ else }}:ok:{{ end }}'
            color: '{{ template "slack.color" . }}'
            title: '{{ template "slack.title" . }}'
            text: '{{ template "slack.text" . }}'
            footer: 'Alertmanager'

      - name: 'slack-backend'
        slack_configs:
          - channel: '#backend-alerts'
            send_resolved: true
            icon_emoji: '{{ if eq .Status "firing" }}:computer:{{ else }}:ok:{{ end }}'
            color: '{{ template "slack.color" . }}'
            title: '{{ template "slack.title" . }}'
            text: '{{ template "slack.text" . }}'
            footer: 'Alertmanager'

    templates:
      - '/etc/alertmanager/templates.tmpl'

  templates.tmpl: |
    {{/* Color of Slack attachment */}}
    {{ define "slack.color" -}}
        {{- if eq .Status "firing" -}}
            {{- if eq .CommonLabels.severity "critical" -}}
                #FF4136
            {{- else if eq .CommonLabels.severity "warning" -}}
                #FF851B
            {{- else -}}
                #0074D9
            {{- end -}}
        {{- else -}}
            #2ECC40
        {{- end -}}
    {{- end }}

    {{/* Title of the Slack alert */}}
    {{ define "slack.title" -}}
        {{- if eq .Status "firing" -}}
            {{- if eq .CommonLabels.severity "critical" -}}
                :rotating_light: CRITICAL ALERT :rotating_light:
            {{- else if eq .CommonLabels.severity "warning" -}}
                :warning: WARNING ALERT :warning:
            {{- else -}}
                :blue_book: INFO ALERT :blue_book:
            {{- end -}}
        {{- else -}}
            :white_check_mark: RESOLVED :white_check_mark:
        {{- end -}}
        {{ .CommonLabels.alertname }}
    {{- end }}
    
    {{/* The text to display in the alert */}}
    {{ define "slack.text" -}}
    *Status:* {{ if eq .Status "firing" }}:fire: Active{{ else }}:white_check_mark: Resolved{{ end }}
    *Severity:* {{ template "slack.severity" . }}
    *Summary:* {{ (index .Alerts 0).Annotations.summary }}
    {{ range .Alerts }}
    ---
    *Description:* {{ .Annotations.description }}
    *Start Time:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
    {{- if ne .Status "firing" }}
    *End Time:* {{ .EndsAt.Format "2006-01-02 15:04:05" }}
    {{- end }}
    *Affected Service:* `{{ .Labels.service }}`
    *Region:* `{{ .Labels.region }}`
    {{- if .Annotations.runbook_url }}
    *Runbook:* <{{ .Annotations.runbook_url }}|Click here>
    {{- end }}
    {{- if .Annotations.dashboard_url }}
    *Dashboard:* <{{ .Annotations.dashboard_url }}|View in Grafana>
    {{- end }}
    {{- if .Annotations.portfolio_impact }}
    *Portfolio Impact:* {{ .Annotations.portfolio_impact }}
    {{- end }}
    {{ end }}
    
    *Alert Group:* `{{ .GroupLabels.alertname }}`
    *Job:* `{{ .CommonLabels.job }}`
    {{- end }}
    
    {{/* Severity of the alert */}}
    {{ define "slack.severity" -}}
    {{- if eq .CommonLabels.severity "critical" -}}
    :red_circle: `CRITICAL`
    {{- else if eq .CommonLabels.severity "warning" -}}
    :large_orange_diamond: `WARNING`
    {{- else if eq .CommonLabels.severity "info" -}}
    :large_blue_circle: `INFO`
    {{- else -}}
    :question: `{{ .CommonLabels.severity }}`
    {{- end }}
    {{- end }}
    
    {{/* Runbook URL */}}
    {{ define "slack.runbook" -}}
    {{- if (index .Alerts 0).Annotations.runbook_url -}}
    {{- (index .Alerts 0).Annotations.runbook_url -}}
    {{- else -}}
    https://wiki.portfogram.com/runbooks
    {{- end -}}
    {{- end }}